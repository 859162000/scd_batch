<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.scd.batch.trade.dao.BatchLoanDAO">

    <sql id="installmentInfoColumns">
        ins.ID,
        ins.CUSTOMER_ID,
        ins.ACCOUNT_ID,
        ins.LOAN_ID,
        ins.PRODUCT_ID,
        ins.PRODUCT_NO,
        ins.ACCOUNT_DATE,
        ins.LOAN_SCHEDULE_NO,
        ins.INSTALLMENT_MADE_NO,
        ins.DUE_DATE,
        ins.GRACE_DATE,
        ins.STATUS,
        ins.PRINCIPAL, ins.PRINCIPAL_REPAY,
        ins.INTEREST, ins.INTEREST_REPAY,
        ins.PENALTY, ins.PENALTY_REPAY,
        ins.OVERDUE, ins.OVERDUE_REPAY,
        ins.CHARGES, ins.CHARGES_REPAY,
        ins.VIOLATE, ins.VIOLATE_REPAY,
        ins.MANAGEMENT, ins.MANAGEMENT_REPAY,
        ins.SERVICE, ins.SERVICE_REPAY,

        loan.LOAN_AGE,
        loan.PENALTY as LOAN_PENALTY,
        loan.OVERDUE as LOAN_OVERDUE,
        loan.LOAN_STATUS,
        loan.FINANCING_SOURCE,
        loan.LOAN_CHANNEL,
        loan.SECURITY_STATUS,
        loan.PENALTY_MULTIPLIER,
        loan.OVERDUE_MULTIPLIER,
        loan.VERSION
    </sql>

    <resultMap id="installmentInfoMap" type="com.scd.batch.trade.model.loan.LoanInstallmentInfo">
        <id property="id" column="ID"/>
        <result property="customerId" column="CUSTOMER_ID"/>
        <result property="accountId" column="ACCOUNT_ID"/>
        <result property="loanId" column="LOAN_ID"/>
        <result property="productId" column="PRODUCT_ID"/>
        <result property="productNo" column="PRODUCT_NO"/>
        <result property="accountDate" column="ACCOUNT_DATE"/>
        <result property="scheduleNo" column="LOAN_SCHEDULE_NO"/>
        <result property="installmentMadeNo" column="INSTALLMENT_MADE_NO"/>
        <result property="dueDate" column="DUE_DATE"/>
        <result property="graceDate" column="GRACE_DATE"/>
        <result property="status" column="STATUS"/>
        <result column="PRINCIPAL" property="principal"/>
        <result column="PRINCIPAL_REPAY" property="principalRepay"/>
        <result column="INTEREST" property="interest"/>
        <result column="INTEREST_REPAY" property="interestRepay"/>
        <result column="PENALTY" property="penalty"/>
        <result column="PENALTY_REPAY" property="penaltyRepay"/>
        <result column="OVERDUE" property="overdue"/>
        <result column="OVERDUE_REPAY" property="overdueRepay"/>
        <result column="CHARGES" property="charges"/>
        <result column="CHARGES_REPAY" property="chargesRepay"/>
        <result column="VIOLATE" property="violate"/>
        <result column="VIOLATE_REPAY" property="violateRepay"/>
        <result column="MANAGEMENT" property="management"/>
        <result column="MANAGEMENT_REPAY" property="managementRepay"/>
        <result column="SERVICE" property="service"/>
        <result column="SERVICE_REPAY" property="serviceRepay"/>

        <result property="loanAge" column="LOAN_AGE"/>
        <result property="loanPenalty" column="LOAN_PENALTY"/>
        <result property="loanOverdue" column="LOAN_OVERDUE"/>
        <result property="loanStatus" column="LOAN_STATUS"/>
        <result property="financialSource" column="FINANCING_SOURCE"/>
        <result property="loanChannel" column="LOAN_CHANNEL"/>
        <result property="securityStatus" column="SECURITY_STATUS"/>

        <result column="PENALTY_MULTIPLIER" property="mPenalty"/>
        <result column="OVERDUE_MULTIPLIER" property="mOverdue"/>

        <result column="VERSION" property="version"/>
    </resultMap>

    <select id="getAllOverdueLoanId" resultType="long">
        select distinct(loan.LOAN_ID)
        from ${__dbPrefix}_${ts.dbId}.T_INSTALLMENT_SCHEDULE_${ts.dbId}_${ts.tableId} ins
        inner join ${__dbPrefix}_${ts.dbId}.T_LOAN_${ts.dbId}_${ts.tableId} loan on ins.LOAN_ID = loan.LOAN_ID
        where
        <![CDATA[
        ins.GRACE_DATE < #{accountDate}
        and ins.STATUS in (1, 7)


        ]]>
    </select>

    <select id="selectInstallmentInfoByLoanId" resultMap="installmentInfoMap">
        select
        <include refid="installmentInfoColumns"/>
        from ${__dbPrefix}_${ts.dbId}.T_INSTALLMENT_SCHEDULE_${ts.dbId}_${ts.tableId} ins
        inner join ${__dbPrefix}_${ts.dbId}.T_LOAN_${ts.dbId}_${ts.tableId} loan on ins.LOAN_ID = loan.LOAN_ID
        where loan.LOAN_ID in
        <foreach collection="loanIdList" item="loanId" open="(" close=")" separator=",">
            #{loanId}
        </foreach>
        <![CDATA[
        and ins.GRACE_DATE < #{accountDate}
        and ins.STATUS in (1, 7)
        order by ins.LOAN_ID
        ]]>
    </select>

    <select id="selectLoanWithInstallment" resultMap="installmentInfoMap">
        select
        <include refid="installmentInfoColumns"/>
        from T_INSTALLMENT_SCHEDULE ins
        inner join T_LOAN loan on ins.LOAN_ID = loan.LOAN_ID

        <![CDATA[
        where loan.LOAN_ID = #{loanId}
              and loan.CUSTOMER_ID = #{customerId}
              and loan.ACCOUNT_ID = #{accountId}
              and ins.GRACE_DATE < #{accountDate}
              and ins.STATUS in (1, 7)
        ]]>
    </select>

    <select id="getAllLoanId" resultType="long">
        select LOAN_ID
        from ${__dbPrefix}_${ts.dbId}.T_LOAN_${ts.dbId}_${ts.tableId}
        where LOAN_STATUS in (2, 3)
    </select>

    <select id="selectInstallmentByLoanIds" resultMap="scheduleInstallmentMap">
        select
        CUSTOMER_ID, PRODUCT_ID, DUE_DATE, GRACE_DATE, LOAN_ID,
        PRINCIPAL, PRINCIPAL_REPAY,
        INTEREST, INTEREST_REPAY,
        PENALTY, PENALTY_REPAY,
        OVERDUE, OVERDUE_REPAY,
        CHARGES, CHARGES_REPAY,
        VIOLATE, VIOLATE_REPAY,
        MANAGEMENT, MANAGEMENT_REPAY,
        SERVICE, SERVICE_REPAY
        from ${__dbPrefix}_${ts.dbId}.T_INSTALLMENT_SCHEDULE_${ts.dbId}_${ts.tableId}
        where LOAN_ID in
        <foreach collection="loanIdList" item="loanId" open="(" close=")" separator=",">
            #{loanId}
        </foreach>
        and STATUS in (1, 7)
    </select>

    <!-- 更新相关 -->
    <update id="updateLoan">
        update T_LOAN
        set OVERDUE = OVERDUE + #{loanInfo.overdueDelta},
        PENALTY = PENALTY + #{loanInfo.penaltyDelta},
        LOAN_AGE = #{loanInfo.age},
        VERSION = VERSION + 1
        where LOAN_ID = #{loanInfo.loanId}
        and CUSTOMER_ID = #{loanInfo.customerId}
        and ACCOUNT_ID = #{loanInfo.accountId}
        and VERSION = #{loanInfo.version}

    </update>

    <update id="updateInstallmentSchedule">
        update T_INSTALLMENT_SCHEDULE
        set OVERDUE = OVERDUE + #{installment.overdueDelta},
        PENALTY = PENALTY + #{installment.penaltyDelta},
        STATUS = 7,
        VERSION = VERSION + 1
        where CUSTOMER_ID = #{installment.customerId}
        and ACCOUNT_ID = #{installment.accountId}
        and LOAN_ID = #{installment.loanId}
        and LOAN_SCHEDULE_NO = #{installment.scheduleNo}
        and INSTALLMENT_MADE_NO = #{installment.installmentMadeNo}
    </update>

    <update id="updateAccountStatus">
        update T_CUSTOMER_ACCOUNT
        set DEBIT_STATUS = #{debitStatus},
            ACCOUNT_AGING = GREATEST(ACCOUNT_AGING, #{loanAge})
        where ACCOUNT_ID = #{accountId}
    </update>


    <!-- 代扣自动还款 -->
    <resultMap id="scheduleInstallmentMap" type="com.scd.batch.trade.model.loan.InstallmentInfo">
        <result property="customerId" column="CUSTOMER_ID"/>
        <result property="accountId" column="ACCOUNT_ID"/>
        <result property="loanId" column="LOAN_ID"/>
        <result property="productId" column="PRODUCT_ID"/>
        <result property="dueDate" column="DUE_DATE"/>
        <result property="graceDate" column="GRACE_DATE"/>
        <result property="status" column="STATUS"/>
        <result property="scheduleNo" column="LOAN_SCHEDULE_NO"/>
        <result property="installmentMadeNo" column="INSTALLMENT_MADE_NO"/>
        <result property="principal" column="PRINCIPAL"/>
        <result property="principalRepay" column="PRINCIPAL_REPAY"/>
        <result property="interest" column="INTEREST"/>
        <result column="INTEREST_REPAY" property="interestRepay"/>
        <result column="PENALTY" property="penalty"/>
        <result column="PENALTY_REPAY" property="penaltyRepay"/>
        <result column="OVERDUE" property="overdue"/>
        <result column="OVERDUE_REPAY" property="overdueRepay"/>
        <result column="CHARGES" property="charges"/>
        <result column="CHARGES_REPAY" property="chargesRepay"/>
        <result column="VIOLATE" property="violate"/>
        <result column="VIOLATE_REPAY" property="violateRepay"/>
        <result column="MANAGEMENT" property="management"/>
        <result column="MANAGEMENT_REPAY" property="managementRepay"/>
        <result column="SERVICE" property="service"/>
        <result column="SERVICE_REPAY" property="serviceRepay"/>
    </resultMap>

    <select id="selectAllOverdueCustomerId" resultType="long">
        select distinct(loan.CUSTOMER_ID)
        from ${__dbPrefix}_${ts.dbId}.T_INSTALLMENT_SCHEDULE_${ts.dbId}_${ts.tableId} ins
        inner join ${__dbPrefix}_${ts.dbId}.T_LOAN_${ts.dbId}_${ts.tableId} loan on ins.LOAN_ID = loan.LOAN_ID
        where
        <![CDATA[
        ins.DUE_DATE <= #{accountDate}
        and ins.STATUS in (1, 7)
        and loan.LOAN_STATUS in (2, 3)

        ]]>
    </select>

    <select id="selectOverdueInstallmentByCustomerId" resultMap="scheduleInstallmentMap">
        select
        CUSTOMER_ID, ACCOUNT_ID, LOAN_ID, PRODUCT_ID,
        DUE_DATE, GRACE_DATE,
        STATUS,
        PRINCIPAL, PRINCIPAL_REPAY,
        INTEREST, INTEREST_REPAY,
        PENALTY, PENALTY_REPAY,
        OVERDUE, OVERDUE_REPAY,
        CHARGES, CHARGES_REPAY,
        VIOLATE, VIOLATE_REPAY,
        MANAGEMENT, MANAGEMENT_REPAY,
        SERVICE, SERVICE_REPAY

        from ${__dbPrefix}_${ts.dbId}.T_INSTALLMENT_SCHEDULE_${ts.dbId}_${ts.tableId}

        where CUSTOMER_ID in
        <foreach collection="customerIdList" item="customerId" open="(" close=")" separator=",">
            #{customerId}
        </foreach>
        <![CDATA[
        and DUE_DATE <= #{accountDate}
        and `STATUS` in (1, 7)
        order by CUSTOMER_ID, LOAN_ID
        ]]>
    </select>

</mapper>